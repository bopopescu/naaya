
<dtml-comment>
    With the following form you can search LDAP users. After that you can use their uid
    to assigned local roles (Issus Administrator, Issue Resolver)
</dtml-comment>
<form name="frmSearch" method="post" action="admin_html">
<table border="0" cellspacing="2" cellpadding="2" width="100%">
    <tr><td class="cellheader" colspan="3"><b>Find an existing user</b></td></tr>
    <tr><td class="cell" colspan="3">Use this form to find user records on the LDAP server and view or edit their details.</td></tr>
    <tr>
        <td class="cell">
            <select name="search_param">
                <dtml-in "hd_users_folder.getLDAPSchema()">
                    <option value="<dtml-var sequence-key html_quote>"><dtml-var sequence-item html_quote>&nbsp;(<dtml-var sequence-key html_quote>)</option>
                </dtml-in>
            </select>
        </td>
        <td>
            <input type="text" name="search_term" size="30" value="">
        </td>
        <td width="100%">
            <input type="hidden" name="pagetab" value="6"><input type="submit" name="search" value="Search">
        </td>
    </tr>
</table>
</form>

<dtml-comment>
    Here are search results
</dtml-comment>
<dtml-if "REQUEST.has_key('search')">
    <script language="javascript">
    <!--
    function fSelectUser(userid)
    {
        var frmadd = document.forms['frmadd'];
        frmadd.zope_user.value = userid;
    }
    //-->
    </script>
    <form name="frmResults">
    <table border="0" cellspacing="2" cellpadding="2" width="100%">
        <tr>
            <td class="cellheader" width="20%">UID</td>
            <td class="cellheader" width="20%">SN</td>
            <td class="cellheader" width="20%">CN</td>
            <td class="cellheader" width="60%">Distinguished Name</td>
        </tr>
        <dtml-in "hd_users_folder.findUser(search_param=search_param, search_term=search_term)" mapping sort="sn">
            <dtml-if sequence-odd>
                <dtml-call "REQUEST.set('cellclass', 'cellodd')">
            <dtml-else>
                <dtml-call "REQUEST.set('cellclass', 'celleven')">
            </dtml-if>
            <tr>
                <td class="<dtml-var cellclass>"><a class="itemlink" href="javascript:fSelectUser('<dtml-var uid html_quote>');"><dtml-var uid html_quote></a></td>
                <td class="<dtml-var cellclass>"><dtml-var sn html_quote></td>
                <td class="<dtml-var cellclass>"><dtml-var cn html_quote></td>
                <td class="<dtml-var cellclass>"><dtml-var dn html_quote></td>
            </tr>
        </dtml-in>
    </table>
    </form>
</dtml-if>
<hr noshade size="1">

<dtml-comment>
    load form data in variables
</dtml-comment>
<dtml-let HDUserName="REQUEST.get('user', '')" HDUser="getUser(HDUserName)">
    <dtml-if HDUser>
        <dtml-call "REQUEST.set('var_mode', 'update')">
        <dtml-call "REQUEST.set('var_form_name', 'frmupdate')">
        <dtml-call "REQUEST.set('var_form_submit_name', 'update')">
        <dtml-call "REQUEST.set('var_form_submit_value', 'Update')">
        <dtml-call "REQUEST.set('var_zope_user', HDUser.zope_user)">
        <dtml-call "REQUEST.set('var_first_name', HDUser.first_name)">
        <dtml-call "REQUEST.set('var_last_name', HDUser.last_name)">
        <dtml-call "REQUEST.set('var_email', HDUser.email)">
        <dtml-call "REQUEST.set('var_role', HDUser.role)">
    <dtml-else>
        <dtml-call "REQUEST.set('var_mode', 'add')">
        <dtml-call "REQUEST.set('var_form_name', 'frmadd')">
        <dtml-call "REQUEST.set('var_form_submit_name', 'add')">
        <dtml-call "REQUEST.set('var_form_submit_value', 'Add')">
        <dtml-call "REQUEST.set('var_zope_user', '')">
        <dtml-call "REQUEST.set('var_first_name', '')">
        <dtml-call "REQUEST.set('var_last_name', '')">
        <dtml-call "REQUEST.set('var_email', '')">
        <dtml-call "REQUEST.set('var_role', [])">
    </dtml-if>
</dtml-let>

<form name="<dtml-var var_form_name>" method="post" action="manageUser">
<table border="0" cellspacing="2" cellpadding="2" width="100%">
    <tr><td class="cellheader" colspan="2"><b>Assign local roles to a LDAP user</b></td></tr>
    <tr>
        <td class="cell">User:</td>
        <td>
            <dtml-if "var_mode == 'update'">
                <b><dtml-var var_zope_user html_quote></b><input type="hidden" name="zope_user" value="<dtml-var var_zope_user html_quote>">
            <dtml-else>
                <input type="text" name="zope_user" value="">
            </dtml-if>
        </td>
    </tr>
    <tr>
        <td class="cell">Role:</td>
        <td>
            <dtml-let administratorRole="getHDRoleAdministrator()" consultantRole="getHDRoleConsultant()">
            <select name="role" size="2" multiple>
                <option value="<dtml-var administratorRole html_quote>" <dtml-if "administratorRole in var_role">selected</dtml-if>><dtml-var administratorRole html_quote></option>
                <option value="<dtml-var consultantRole html_quote>" <dtml-if "consultantRole in var_role">selected</dtml-if>><dtml-var consultantRole html_quote></option>
            </select>
            </dtml-let>
        </td>
    </tr>
    <tr><td class="cell">&nbsp;</td><td class="cell"><input type="submit" name="<dtml-var var_form_submit_name>" value="<dtml-var var_form_submit_value>"></td></tr>
</table>
</form>
