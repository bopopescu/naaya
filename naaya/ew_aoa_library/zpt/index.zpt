<metal:block metal:use-macro="here/standard_template_macro">
<metal:block fill-slot="meta">
    <meta tal:define="description here/description;
                      content python:here.html2text(description);"
          tal:condition="content"
          tal:attributes="content content" name="description" />
    <meta tal:attributes="content here/contributor" name="author" />
    <meta tal:attributes="content here/gl_get_selected_language"
          name="dc.language" />
    <meta tal:attributes="content string:${here/title} | ${here/site_title}"
          name="title" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
</metal:block>

<metal:block fill-slot="body"
	tal:define="review_template python:here.target_path == 'tools/general_template/general-template';
		shadows options/shadows;">

<h1 tal:content="here/title_or_id"></h1>
<script type="text/javascript">
	$(document).ready(function(){
		$('#javascript_label').hide();
		$('#searchbox').parent().show();
		$('#filter_answers').show();
		/*Search in page*/
		$.expr[':'].icontains = function(obj, index, meta, stack){
			return (obj.textContent || obj.innerText || jQuery(obj).text() || '').toLowerCase().indexOf(meta[3].toLowerCase()) >= 0;
		};
		$('#searchbox').keyup(function(){
			var searchString = $(this).val();

			if (searchString.length > 0){
				reset_checkboxes();
				$('.datatable tbody tr').hide();
				$('.datatable tr:icontains('+searchString+')').show();
			}
			else {
			  $('.datatable tr').show();
			}
		})
		if ($('#answers_filter').val() == 'False'){
			select_toggle = 'Off'
		}
		else{
			select_toggle = 'On'
		};
		if (select_toggle == 'On'){
			select_checkboxes();
			show_filters();
		}
		$('#reset_checkboxes').click(function(){
			if (select_toggle == 'Off'){
				select_toggle = 'On';
				select_checkboxes();
			}
			else{
				select_toggle = 'Off';
				reset_checkboxes();
			}
		});
		function show_filters(){
			$('#filter_box').show();
			$('#show_filters').hide();
		}
		$('#show_filters').click(function(){
			show_filters();
		});
		function select_checkboxes(){
			$('[name="answer_ids"]').attr('checked', 'checked');
			$('#reset_checkboxes').attr('checked', 'checked');
		}
		function reset_checkboxes(){
			$('[name="answer_ids"]').removeAttr('checked');
			$('#reset_checkboxes').removeAttr('checked');
		}
})
</script>
<div class="field" id="javascript_label">
	<label i18n:translate="" >The filter function requires javascript</label>
</div>
<div class="field-inline" tal:condition="shadows">
	<label id="search_label" i18n:translate="" >Show reports containing text</label>
	<input type="text" id="searchbox" size="50"/>
	<a class="filter_answers" id="show_filters" href="javascript:void();"
	i18n:translate="" tal:condition="review_template">Advanced filtering</a>
</div>
<br/>
<fieldset id="filter_box" tal:condition="review_template" style="display:none">
	<legend i18n:translate="">Advanced filtering</legend>
	<form method="post" action=".">
		<div style="float:left">
			<div class="field">
				<label for="official_country_region" i18n:translate="">Geo coverage (country or region)</label>
				<input type="text" name="official_country_region:utf8:ustring" size="50"
					tal:attributes="value options/official_country_region|nothing"/>
			</div>
			<div class="field-inline" tal:condition="here/checkPermissionPublishObjects">
				<label for="show_unapproved" i18n:translate="">Show unapproved answers</label>
				<input type="checkbox" name="show_unapproved" tal:attributes="checked options/show_unapproved|nothing"/>
			</div>
		</div>
		<div class="field" style="float:left" tal:define="themes options/themes|python:[]">
			<label for="themes" i18n:translate="">Report themes</label>
			<select name="themes" multiple="True">
				<option i18n:translate="" value="w_water-ressources-topics"
					tal:attributes="selected python:'w_water-ressources-topics' in themes">Water resources topics</option>
				<option i18n:translate="" value="w_water-resource-management-topics"
				tal:attributes="selected python:'w_water-resource-management-topics' in themes">Water resource management topics</option>
				<option i18n:translate="" value="w_green-economy-topics"
				tal:attributes="selected python:'w_green-economy-topics' in themes">Green economy topics</option>
				<option i18n:translate="" value="w_resource-efficiency-topics"
				tal:attributes="selected python:'w_resource-efficiency-topics' in themes">Resource efficiency topics</option>
			</select>
		</div>
		<div class="clearer" ></div>
		<div class="field">
			<input type="submit" value="Apply filter" i18n:attributes="value"
				name="filter_answers:method"/>
		</div>
	</form>
</fieldset>
<form name="select_for_report" method="post" action=".">
<div class="create-stats" tal:condition="python: review_template and shadows">
	<input type="submit" value="Create statistics with selected answers"
		name="viewer_view_report_html:method" i18n:attributes="value"/>
</div>
<div class="message-error field" tal:condition="not:shadows">
	<label i18n:translate="">No answers were found for this query.</label>
</div>
<table class="datatable" style="width:100%" tal:condition="shadows"
	tal:define="skey request/skey|string:modification_time;
				rkey python:bool(request.get('rkey')) or not request.get('skey');
				filter options/filter">
	<input type="hidden" id="answers_filter" tal:attributes="value filter"/>
	<!-- If the "sort by" property has an attribute "lower",
		convert the value to lower before sorting -->
    <tal:block condition="shadows">
	<tal:block condition="python:hasattr(shadows[0].get(skey), 'lower')">
		<tal:block define="dummy python:shadows.sort(key=lambda x: x.get(skey).lower(), reverse=rkey);" />
	</tal:block>
	<tal:block condition="python:not hasattr(shadows[0].get(skey), 'lower')">
		<tal:block define="dummy python:shadows.sort(key=lambda x: x.get(skey), reverse=rkey);" />
	</tal:block>
	<tal:block condition="python:skey == 'approved_date'" >
		<tal:block define="dummy python:shadows.sort(key=lambda x: here.approved_date(x), reverse=rkey);" />
	</tal:block>
    </tal:block>

<thead tal:define="url here/absolute_url">
<tr>
	<th rowspan="2" tal:condition="review_template">
		<input type="checkbox" id="reset_checkboxes"/>
	</th>
	<!-- Name -->
	<th rowspan="2" tal:condition="python:rkey and skey=='title' or skey!='title'">
		<a i18n:translate="" tal:attributes="href string:${url}?skey=title">Name</a>
		<img tal:condition="python:skey=='title'" src="misc_/Naaya/sort_desc.gif" style="vertical-align: middle"/>
	</th>
	<th rowspan="2" tal:condition="python:not rkey and skey=='title'">
		<a i18n:translate="" tal:attributes="href string:${url}?skey=title&rkey=True">Name</a>
		<img tal:condition="python:skey=='title'" src="misc_/Naaya/sort_asc.gif" style="vertical-align: middle"/>
	</th>

	<!-- Cannot sort by themes -->
	<th rowspan="2" tal:condition="not:review_template" i18n:translate="">Themes</th>

	<!-- Last modified -->
	<th rowspan="2" tal:condition="python:rkey and skey=='modification_time' or skey!='modification_time'">
		<a i18n:translate="" tal:attributes="href string:${url}?skey=modification_time">Last modified</a>
		<img tal:condition="python:skey=='modification_time'" src="misc_/Naaya/sort_desc.gif" style="vertical-align: middle"/>
	</th>
	<th rowspan="2" tal:condition="python:not rkey and skey=='modification_time'">
		<a i18n:translate="" tal:attributes="href string:${url}?skey=modification_time&rkey=True">Last modified</a>
		<img tal:condition="python:skey=='modification_time'" src="misc_/Naaya/sort_asc.gif" style="vertical-align: middle"/>
	</th>

	<!-- Reported by -->
	<th rowspan="2" tal:condition="python:rkey and skey=='uploader' or skey!='uploader'">
		<a i18n:translate="" tal:attributes="href string:${url}?skey=uploader">Reported by</a>
		<img tal:condition="python:skey=='uploader'" src="misc_/Naaya/sort_desc.gif" style="vertical-align: middle"/>
	</th>
	<th rowspan="2" tal:condition="python:not rkey and skey=='uploader'">
		<a i18n:translate="" tal:attributes="href string:${url}?skey=uploader&rkey=True">Reported by</a>
		<img tal:condition="python:skey=='uploader'" src="misc_/Naaya/sort_asc.gif" style="vertical-align: middle"/>
	</th>

	<!-- Country -->
	<th rowspan="2" tal:condition="python:rkey and skey=='country' or skey!='country'">
		<a i18n:translate="" tal:attributes="href string:${url}?skey=country">Country</a>
		<img tal:condition="python:skey=='country'" src="misc_/Naaya/sort_desc.gif" style="vertical-align: middle"/>
	</th>
	<th rowspan="2" tal:condition="python:not rkey and skey=='country'">
		<a i18n:translate="" tal:attributes="href string:${url}?skey=country&rkey=True">Country</a>
		<img tal:condition="python:skey=='country'" src="misc_/Naaya/sort_asc.gif" style="vertical-align: middle"/>
	</th>

	<th tal:condition="review_template" colspan="2" i18n:translate="">Geo coverage:</th>

	<!-- Approval status -->
	<th rowspan="2" tal:condition="python:review_template and (rkey and skey=='approved_date' or skey!='approved_date')">
		<a i18n:translate="" tal:attributes="href string:${url}?skey=approved_date">Approval status</a>
		<img tal:condition="python:skey=='approved_date'" src="misc_/Naaya/sort_desc.gif" style="vertical-align: middle"/>
	</th>
	<th rowspan="2" tal:condition="python:review_template and not rkey and skey=='approved_date'">
		<a i18n:translate="" tal:attributes="href string:${url}?skey=approved_date&rkey=True">Approval status</a>
		<img tal:condition="python:skey=='approved_date'" src="misc_/Naaya/sort_asc.gif" style="vertical-align: middle"/>
	</th>

	<!-- Approval status -->
	<th rowspan="2" tal:condition="python:review_template and (rkey and skey=='approved_date' or skey!='approved_date')">
		<a i18n:translate="" tal:attributes="href string:${url}?skey=approved_date">Approval date</a>
		<img tal:condition="python:skey=='approved_date'" src="misc_/Naaya/sort_desc.gif" style="vertical-align: middle"/>
	</th>
	<th rowspan="2" tal:condition="python:review_template and not rkey and skey=='approved_date'">
		<a i18n:translate="" tal:attributes="href string:${url}?skey=approved_date&rkey=True">Approval date</a>
		<img tal:condition="python:skey=='approved_date'" src="misc_/Naaya/sort_asc.gif" style="vertical-align: middle"/>
	</th>
</tr>
<tr>
	<!-- Geo coverage: country -->
	<th tal:condition="python:review_template and (rkey and skey=='geo_coverage_country' or skey!='geo_coverage_country')">
		<a i18n:translate="" tal:attributes="href string:${url}?skey=geo_coverage_country">Country</a>
		<img tal:condition="python:skey=='geo_coverage_country'" src="misc_/Naaya/sort_desc.gif" style="vertical-align: middle"/>
	</th>
	<th tal:condition="python:review_template and not rkey and skey=='geo_coverage_country'">
		<a i18n:translate="" tal:attributes="href string:${url}?skey=geo_coverage_country&rkey=True">Country</a>
		<img tal:condition="python:skey=='geo_coverage_country'" src="misc_/Naaya/sort_asc.gif" style="vertical-align: middle"/>
	</th>

	<!-- Geo coverage: region -->
	<th tal:condition="python:review_template and (rkey and skey=='geo_coverage_region' or skey!='geo_coverage_region')">
		<a i18n:translate="" tal:attributes="href string:${url}?skey=geo_coverage_region">Region</a>
		<img tal:condition="python:skey=='geo_coverage_region'" src="misc_/Naaya/sort_desc.gif" style="vertical-align: middle"/>
	</th>
	<th tal:condition="python:review_template and not rkey and skey=='geo_coverage_region'">
		<a i18n:translate="" tal:attributes="href string:${url}?skey=geo_coverage_region&rkey=True">Region</a>
		<img tal:condition="python:skey=='geo_coverage_region'" src="misc_/Naaya/sort_asc.gif" style="vertical-align: middle"/>
	</th>
</tr>
</thead>
<tbody>
<tr tal:repeat="i shadows">
<tal:block define="topics_as_label python:'Topics:\n\n' + ''.join('* %s\n' % t for t in i.topics)">
	<td tal:condition="review_template"><input type="checkbox" name="answer_ids" tal:attributes="value i/id" /></td>
	<td>
			<a tal:define="url i/absolute_url" tal:attributes="href string:${url}; title topics_as_label" tal:content="python: i.get('title')"></a>
	</td>
	<td tal:condition="not:review_template">
		<ul><li tal:repeat="t python:i.theme or []" tal:content="t" /></ul>
	</td>
	<td tal:content="python: here.utShowFullDateTime(i.modification_time)"/>
	<td tal:content="python:i.get('uploader')"/>
	<td tal:content="python:i.get('country')"/>
	<td tal:condition="review_template"
		tal:content="i/geo_coverage_country|nothing"/>
	<td tal:condition="review_template"
		tal:content="i/geo_coverage_region|nothing"/>
	<td i18n:translate="" tal:condition="review_template" >
        <span tal:condition="python:here.approved_date(i)">Approved</span>
        <span tal:condition="python:not here.approved_date(i)">Pending</span>
    </td>
	<td tal:condition="review_template" tal:content="python: here.utShowFullDateTime(here.approved_date(i))"/>
</tal:block>
</tr>
</tbody>
</table>
</form>
</metal:block>

</metal:block>
